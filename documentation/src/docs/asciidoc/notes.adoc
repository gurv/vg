:toc-title: Содержимое
:images: ./images
:icons: font

= VG.Техническая документация

== Обзор

* Технологии

image::gradle.png[]
image::nodejs.png[]
image::spring.png[]
image::angular.jpg[]
image::docker.png[]

* Компоненты

[plantuml, services, png]
....
left header
Диаграмма компонент
endheader

[Web]
note right of [Web]
  Angular
end note
[Gateway]
note right of [Gateway]
  Zuul
end note
[Config]
[Discovery]
note right of [Discovery]
  Eureka
end note
[Auth]
note right of [Auth]
  OAuth2
end note
[Account]
[Metadata]
[DbServer]
[DbData]
note left of [DbServer]
  H2
end note
[Web] --> [Gateway]
[Gateway] --> [Discovery]
[Gateway] --> [Config]
[Gateway] --> [Auth]
[Gateway] --> [Account]
[Gateway] --> [Metadata]
[Account] --> [Discovery]
[Account] --> [Config]
[Account] --> [DbServer] : TCP
[Auth] --> [Discovery]
[Auth] --> [Config]
[Auth] --> [DbServer] : TCP
[Discovery] <--> [Config]
[Metadata] --> [Config]
[Metadata] --> [Discovery]
[Metadata] --> [DbServer] : TCP
[DbServer] --> [Config]
[DbServer] -- [DbData] : Docker Storage Volume
....

* Порты сервисов

[cols="2*", options="header"]
|===
|Сервис
|Порт

|Config
|8888

|Discovery
|8761

|Gateway
|10000; 8000 (Sidecar)

|Auth
|5000

|Account
|8081

|Metadata
|8082

|Хранилище данных
|8083, 9093 (TCP)
|===

== Разработчику

* Инструменты

[plantuml, dev-env, png]
....
[Docker]
[Gradle] ..> [Java]
[Asciidoc] ..> [Java]
[Asciidoc] ..> [GraphViz]
[Webpack] ..> [NodeJS]
....

* Сборка

[source]
----
gradle build
----
[TIP]
====
Тайминг 20170303: 2 mins 3.568 secs
====

* Сборка Docker-образов

[source]
----
gradle buildDockerImage
----
[TIP]
====
* Тайминг 20170303: 4 mins 6.054 secs
* На этапе сборки подпроекта web может быть сообщение "FAILURE: Build failed with an exception." - игнорировать
====

* Запуск в Docker-е с локальными файлами данных DB-хранилища

[source]
----
docker-compose -f docker-compose.dev.db.yml -f docker-compose.dev.db.local.yml -f docker-compose.dev.services.yml up -d
----
[TIP]
====
По состоянию на 20170303: требуется 2 шт. таких запуска, т.к. при первом пуске сервис Gateway так и не соединился с сервисом Config
====

* Запуск в Docker-е Stream-инфраструктуры (Kafka/...)

[source]
----
docker-compose -f docker-compose.dev.stream.yml  up -d
----

* Останов сервисов в Docker-е

[source]
----
docker-compose -f docker-compose.dev.services.yml stop
----

* Останов хранилища данных в Docker-е

[source]
----
docker-compose -f docker-compose.dev.db.yml stop
----


* Создание ключей

[source]
----
C:\app\java\jre1.8.0_92\bin\keytool.exe -genkeypair -alias vg -keyalg RSA -dname "CN=vg" -keystore vg.jks -keypass 1q2w3e4r -storepass 1q2w3e4r
C:\app\java\jre1.8.0_92\bin\keytool.exe -export -keystore vg.jks -alias vg -rfc -storepass 1q2w3e4r -file vg.cer
C:\app\openSSL\bin\openssl.exe x509 -inform pem -pubkey -in vg.cer
----

* Удаление контейнеров остановленных сервисов в Docker-е

[source]
----
docker-compose -f docker-compose.dev.db.yml -f docker-compose.dev.services.yml rm
----

* Удаление всех сборок
[source]
----
gradle clean
----

== Сервисы

=== Конфигуратор (Config)
* Проверка доступности (на примере получения значения настроек по умолчанию сервиса Discovery)

http://localhost:8888/discovery/default

* Запуск (в примере - версия 0.1.0)
[source]
----
java -jar config/build/libs/vg-config-0.1.0.jar
----
* Запуск без сборки (используется spring-boot-devtools)
[source]
----
gradle :config:bootRun
----
* Сборка
[source]
----
gradle :config:build
----
* Сборка Docker-образа
[source]
----
gradle :config:buildDockerImage
----
* Удаление всей сборки
[source]
----
gradle :config:clean
----

=== Обнаружитель (Discovery)
* Web-консоль http://localhost:8761/
* Запуск (в примере - версия 0.1.0)
[source]
----
java -jar discovery/build/libs/vg-discovery-0.1.0.jar
----
* Запуск без сборки (используется spring-boot-devtools)
[source]
----
gradle :discovery:bootRun
----
* Сборка
[source]
----
gradle :discovery:buildDockerImage
----
* Сборка Docker-образа
[source]
----
gradle :discovery:build
----
* Удаление всей сборки
[source]
----
gradle :discovery:clean
----

=== Авторизация (Auth)
* Endpoint сервиса http://localhost:5000/uaa
* Запуск (в примере - версия 0.1.0)
[source]
----
java -jar auth/build/libs/vg-auth-0.1.0.jar
----
* Запуск без сборки (используется spring-boot-devtools)
[source]
----
gradle :auth:bootRun
----
* Сборка
[source]
----
gradle :auth:buildDockerImage
----
* Сборка Docker-образа
[source]
----
gradle :auth:build
----
* Удаление всей сборки
[source]
----
gradle :auth:clean
----

=== Учетные записи (Account)

* Запуск (в примере - версия 0.1.0)
[source]
----
java -jar account/build/libs/vg-account-0.1.0.jar
----

* Запуск без сборки (используется spring-boot-devtools)
[source]
----
gradle :account:bootRun
----
[TIP]
====
.В этом режиме:
* Отключены взаимодействия с сервисами Config и Discovery
* DB-сервер - это H2 (embedded mode; in-memory databases) с WEB-консолью http://localhost:8081/db-console и JDBC URL jdbc:h2:mem:account

====

* Сборка
[source]
----
gradle :account:build
----

* Сборка Docker-образа
[source]
----
gradle :account:buildDockerImage
----

* Удаление всей сборки
[source]
----
gradle :account:clean
----

=== Gateway (Gateway)

* Web-консоль сервиса http://localhost:10000/

* Запуск (в примере - версия 0.1.0)
[source]
----
java -jar gateway/build/libs/vg-gateway-0.1.0.jar
----

* Запуск без сборки (используется spring-boot-devtools)
[source]
----
gradle :gateway:bootRun
----

* Сборка
[source]
----
gradle :gateway:build
----

* Сборка Docker-образа
[source]
----
gradle :gateway:buildDockerImage
----

* Удаление всей сборки
[source]
----
gradle :gateway:clean
----

=== Модель данных (Metadata)

* Проверка доступности

http://localhost:8082/test

* Сборка (если требуется) и запуск сервиса
[source]
----
gradle :metadata:bootRun
----

* Запуск (без Gradle) сервиса (в примере - версии 0.1.0)
[source]
----
java -jar metadata/build/libs/vg-metadata-0.1.0.jar --eureka.client.enabled=false --spring.cloud.config.fail-fast=false
----

* Web-console хранилища данных

http://localhost:8082/db-console

в поле JDBC URL указать
[source]
----
jdbc:h2:tcp://localhost:9093/metadata
----

=== Хранилище данных (Database)

* Web-консоль
http://localhost:8083
[TIP]
====
.Примеры значений JDBC URL:
* jdbc:h2:metadata
* jdbc:h2:tcp://localhost:9093/auth
* jdbc:h2:tcp://database-server:9093/account
====

* Запуск DB-сервера в Docker-е с локальным DB-хранилищем
[source]
----
docker-compose -f docker-compose.dev.db.yml -f docker-compose.dev.db.local.yml up -d
----
[TIP]
====
Файлы локального DB-хранилища размещаютя в каталоге ./.dev/db_data
====

* Запуск DB-сервера в Docker-е с Docker-DB-хранилищем
[source]
----
docker-compose -f docker-compose.dev.db.yml -f docker-compose.dev.db.docker.yml up -d
----

* Сборка Docker-образа DB-сервера
[source]
----
gradle :database:buildServerDockerImage
----

== WEB-приложение

* Запуск в dev-режиме
----
npm run proxy-start
----

* Сборка (в каталог last-build)
----
npm run prod-build
----

* Удаление сборки
----
npm run dist-clean
----

== Документация

* Сформировать документацию
[source]
----
gradle asciidoctor
----

* Открыть документацию в броузере
[source]
----
documentation/build/asciidoc/html5/notes.html
----

== Примеры

=== Операции

Ссылки:

http://localhost:8080/ping

http://localhost:8080/db-console

http://localhost:8080/browser/index.html#/

http://localhost:8080/operation

http://localhost:8080/operation/1

http://localhost:8080/operation/?size=5

http://localhost:8080/operation?page=0

http://localhost:8080/operation/search/countByTimestampLessThanEqual?ts=2019-01-01T01:30:00.000-04:00

http://localhost:8080/profile/operation

http://localhost:8080/operations/operation

== Заметки

=== Docker

* Список образов
[source]
----
docker images
----

* Удаление всех образов
[source]
----
powershell .\docker.clean.ps1
----
[WARNING]
====
не проверено в режиме имеющихся контейнеров
====

=== Gradle

* Параметры выполнения bootRun
[source]
----
bootRun {
    args = ["--spring.cloud.config.failFast=true"]
    systemProperties = [
            'spring.h2.console.enabled'  : true,
            'spring.h2.console.path'     : '/console'
    ]
}
----

== TODO

* Перейти на формат файла Docker Compose версии 3
